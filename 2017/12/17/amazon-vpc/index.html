<!DOCTYPE html><html lang="ja" data-reactroot=""><head><title data-react-helmet="true">Amazpn VPCで踏み台経由でログインできるネットワーク環境をつくってみる - BAKUNOTE</title><meta data-react-helmet="true" name="description" content="Amazpn VPCで踏み台経由でログインできるネットワーク環境をつくってみる aws,vpcに関する記事。bakunyoの技術ノート。ruby, javascriptに関することやその他日々の記録です。"/><link data-react-helmet="true" rel="canonical" href="https://blog.bakunyo.com/2017/12/17/amazon-vpc/"/><meta charSet="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><style type="text/css" data-styled-components="cnWmGe gigDMW hPFOEi cZCpqm" data-styled-components-is-local="true">/* sc-component-id: twitter__Styles-ixfWcN */

.hPFOEi a.button{display:block;padding:0.5rem 1rem;color:#fefefe;background:#1583cc;width:3rem;text-align:center;border-radius:0.2rem;font-size:0.9rem;}.hPFOEi a.button svg{font-size:1.5rem;}
/* sc-component-id: Post__Styles-hlBIeG */

.gigDMW h1{font-size:2.5rem;}.gigDMW .postInfo{margin-bottom:3rem;}.gigDMW .postInfo .postMeta{margin-right:3rem;}.gigDMW .socialButtons{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}.gigDMW .socialButtons div,.gigDMW .socialButtons iframe{margin-right:0.5rem;}.gigDMW .postContent{margin-bottom:5rem;}.gigDMW .postContent ul.tags{margin:0.5rem 0;}.gigDMW .postContent h2{font-size:1.8rem;padding-bottom:0.5rem;border-bottom:1px #ccc solid;margin-top:4rem;}.gigDMW .postContent h3{font-size:1.6rem;margin-top:3rem;}.gigDMW .postContent h4{font-size:1.4rem;margin-top:2rem;}.gigDMW .postContent h5{font-size:1.3rem;}.gigDMW .postContent blockquote{font-size:1.3rem;font-style:italic;color:#aaa;border-top:1px #ccc solid;border-bottom:1px #ccc solid;width:95%;margin:2.5rem 0;}.gigDMW .postContent pre > code{padding:1.2rem;}.gigDMW .postContent p > code{background:#eaeaea;padding:0 0.4rem;border-radius:0.1rem;}.gigDMW .postContent table{border-collapse:collapse;width:100%;}.gigDMW .postContent table th[style="text-align:right"]{display:none;}.gigDMW .postContent table td[style="text-align:right"]{text-align:left !important;}.gigDMW .postContent table th{background:#555;color:#fff;border:1px #ccc solid;padding:1rem 0.8rem;}.gigDMW .postContent table td{border:1px #ccc solid;padding:0.8rem;}.gigDMW .postContent ul,.gigDMW .postContent ol{font-size:1.1rem;}.gigDMW .postContent ul li,.gigDMW .postContent ol li{margin-bottom:0.3rem;}.gigDMW .postContent hr{margin:3rem 0;}.gigDMW .postContent p{font-size:1.1rem;}.gigDMW .postContent img{margin:2rem 0;box-shadow:0px 5px 15px -5px rgba(0,0,0,0.8);}
/* sc-component-id: Header__Styles-jQxfpP */

.cnWmGe header{width:100%;border-bottom:1px #aaa solid;margin-bottom:1rem;text-align:center;cursor:pointer;}.cnWmGe header:hover{color:#2199e8;}.cnWmGe header a:visited{color:inherit;}.cnWmGe header h1{font-size:3rem;font-weight:normal;margin-bottom:0.3rem;margin-top:0;padding-top:1.5rem;}.cnWmGe header p{margin-top:0;margin-bottom:1.5rem;}
/* sc-component-id: Footer__Styles-fSAnuS */

.cZCpqm footer{margin-top:1rem;padding:1rem;background:#eee;text-align:center;}.cZCpqm footer nav{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;margin-bottom:2rem;}@media screen and (max-width:800px){.cZCpqm footer nav{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}}.cZCpqm footer nav section{text-align:left;margin:0 2rem 1rem 0;-webkit-flex:1;-ms-flex:1;flex:1;}.cZCpqm footer nav section.profile div.self{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-bottom:1rem;}.cZCpqm footer nav section.profile div.self svg{height:1.5rem;width:1.5rem;}.cZCpqm footer nav section.profile div.self img{width:6rem;height:6rem;border-radius:3rem;}.cZCpqm footer nav section.profile div.self p{margin:0 0 0 1rem;}.cZCpqm footer nav section.links ul.tags{margin:0.6rem 0;}.cZCpqm footer nav section.links ul.tags li{margin-left:0.2rem;}
</style><style type="text/css" data-styled-components="" data-styled-components-is-local="false">/* sc-component-id: sc-global-2664804883 */
body{font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue","Segoe UI","Noto Sans Japanese","ヒラギノ角ゴ ProN W3",Meiryo,sans-serif;font-weight:400;font-size:16px;margin:0;padding:0;}
</style><style type="text/css" data-styled-components="dSmsZX" data-styled-components-is-local="true">/* sc-component-id: App__AppStyles-jGLnGW */

.dSmsZX a{text-decoration:none;}@media screen and (min-width:801px){.dSmsZX .content,.dSmsZX nav{width:800px;margin:0 auto;}}.dSmsZX .content{padding:1rem;}.dSmsZX img{max-width:100%;}.dSmsZX p.date{margin:0;}.dSmsZX p.date svg{width:1.3rem;height:1.3rem;margin-right:0.5rem;}.dSmsZX p.date span{vertical-align:bottom;}.dSmsZX ul.tags{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;list-style:none;padding-left:0;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}.dSmsZX ul.tags li{font-size:0.9rem;background:#2199e8;margin:0.2rem;color:#ffffff;padding:0.2rem 0.5rem;border-radius:0.1rem;cursor:pointer;}.dSmsZX ul.tags li:first-child{margin-left:0;}.dSmsZX ul.tags li:hover{background:#008cba;-webkit-transition:all 0.2s ease-in-out;transition:all 0.2s ease-in-out;}
</style><link rel="stylesheet" href="https://blog.bakunyo.com/highlight/vs2015.css"/><link rel="icon" href="https://blog.bakunyo.com/favicon.ico"/><link rel="self" href="https://blog.bakunyo.com/atom"/></head><body><div id="root"><div class="App__AppStyles-jGLnGW dSmsZX" data-reactroot=""><div class="Header__Styles-jQxfpP cnWmGe"><header><a href="https://blog.bakunyo.com/"><h1>BAKUNOTE</h1><p>bakunyoの技術ノート</p></a></header></div><div class="content"><div class="Post__Styles-hlBIeG gigDMW"><h1>Amazpn VPCで踏み台経由でログインできるネットワーク環境をつくってみる</h1><div class="postInfo"><div class="postMeta"><p class="date"><svg fill="currentColor" preserveAspectRatio="xMidYMid meet" height="1em" width="1em" viewBox="0 0 40 40" style="vertical-align:middle"><g><path d="m4.4 37.1h6.4v-6.4h-6.4v6.4z m7.8 0h7.2v-6.4h-7.2v6.4z m-7.8-7.8h6.4v-7.2h-6.4v7.2z m7.8 0h7.2v-7.2h-7.2v7.2z m-7.8-8.6h6.4v-6.4h-6.4v6.4z m16.4 16.4h7.1v-6.4h-7.1v6.4z m-8.6-16.4h7.2v-6.4h-7.2v6.4z m17.2 16.4h6.4v-6.4h-6.4v6.4z m-8.6-7.8h7.1v-7.2h-7.1v7.2z m-7.9-19.3v-6.4q0-0.3-0.2-0.5t-0.5-0.2h-1.4q-0.3 0-0.5 0.2t-0.2 0.5v6.4q0 0.3 0.2 0.5t0.5 0.2h1.4q0.3 0 0.5-0.2t0.2-0.5z m16.5 19.3h6.4v-7.2h-6.4v7.2z m-8.6-8.6h7.1v-6.4h-7.1v6.4z m8.6 0h6.4v-6.4h-6.4v6.4z m0.7-10.7v-6.4q0-0.3-0.2-0.5t-0.5-0.2h-1.5q-0.3 0-0.5 0.2t-0.2 0.5v6.4q0 0.3 0.2 0.5t0.5 0.2h1.5q0.2 0 0.5-0.2t0.2-0.5z m8.5-1.4v28.5q0 1.2-0.8 2.1t-2 0.8h-31.4q-1.2 0-2.1-0.9t-0.8-2v-28.5q0-1.2 0.8-2t2.1-0.9h2.8v-2.1q0-1.5 1.1-2.6t2.5-1h1.4q1.5 0 2.5 1.1t1.1 2.5v2.1h8.6v-2.1q0-1.5 1-2.6t2.5-1h1.5q1.4 0 2.5 1.1t1 2.5v2.1h2.9q1.1 0 2 0.9t0.8 2z"></path></g></svg><span>2017/12/17 13:30</span></p><ul class="tags"><a href="https://blog.bakunyo.com/tags/aws/"><li>aws</li></a><a href="https://blog.bakunyo.com/tags/vpc/"><li>vpc</li></a></ul></div></div><div class="postContent"><h1>背景</h1>
<p>個人開発で使える本番サーバー環境が欲しかったのと、ちょうど仕事でも活かせそうだったので、自分でAWSのネットワーク環境を作ってみました。</p>
<h1>全体像</h1>
<p>用意したいサーバーは2つです。</p>
<ul>
<li>踏み台
<ul>
<li>sshでログインし、さらにsshで本番サーバーへログインするためのもの</li>
<li>sshログイン用のport以外は開けない</li>
</ul>
</li>
<li>本番サーバー
<ul>
<li>踏み台サーバーからのみsshでログイン可能</li>
<li>(Webサーバーを予定してるけど、今回はhttpのportを開けたりとかしない)</li>
</ul>
</li>
</ul>
<h1>VPCの作成</h1>
<p>AWSで管理する仮想ネットワークを定義します。</p>
<h4>AWSマネジメントコンソールからサービス＞VPCを選択</h4>
<p><img src="https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/1-dashboard.png" alt="vpc-dashboard"></p>
<p>既にデフォルトのVPCが定義されていますが、今回は使わずに削除します。</p>
<h4>「VPCの作成」を選択</h4>
<p><img src="https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/2-create-vpc.png" alt="vpc-create"></p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Name</td>
<td style="text-align:left">vpc-sample</td>
</tr>
<tr>
<td style="text-align:left">IPv4 CIDR ブロック</td>
<td style="text-align:left">192.168.0.0/16</td>
</tr>
</tbody>
</table>
<p>CIDR ブロックは、仮想ネットワーク内のIPアドレスの範囲を指定します。<br>
今回は <code>192.168.0.0</code> ~ <code>192.168.255.255</code> で 65,536 個のIPアドレスを持つことになります。<br>
<a href="http://docs.aws.amazon.com/ja_jp/AmazonVPC/latest/UserGuide/VPC_Subnets.html">VPC とサブネット</a></p>
<p>CIDRブロックは 16~28の間で指定する必要があるようです。</p>
<h1>サブネットの作成</h1>
<p>上で作成したVPCの中でネットワークを小分けにします。</p>
<h4>VPCダッシュボードの中から「サブネット」を選択</h4>
<p><img src="https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/3-subnet-dashboard.png" alt="subnet-dashboard"><br>
「サブネットの作成」を選択し、以下2つのサブネットを作成しました。</p>
<h4>1つ目</h4>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">名前タグ</td>
<td style="text-align:left">subnet-sample-public</td>
</tr>
<tr>
<td style="text-align:left">VPC</td>
<td style="text-align:left">{作成したvpc-sampleがデフォルトで選択されている}</td>
</tr>
<tr>
<td style="text-align:left">アベイラビリティゾーン</td>
<td style="text-align:left">ap-northeast-1a</td>
</tr>
<tr>
<td style="text-align:left">IPv4 CIDR ブロック</td>
<td style="text-align:left">192.168.1.0/24</td>
</tr>
</tbody>
</table>
<h4>2つ目</h4>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">名前タグ</td>
<td style="text-align:left">subnet-sample-private</td>
</tr>
<tr>
<td style="text-align:left">VPC</td>
<td style="text-align:left">{作成したvpc-sampleがデフォルトで選択されている}</td>
</tr>
<tr>
<td style="text-align:left">アベイラビリティゾーン</td>
<td style="text-align:left">ap-northeast-1a</td>
</tr>
<tr>
<td style="text-align:left">IPv4 CIDR ブロック</td>
<td style="text-align:left">192.168.2.0/24</td>
</tr>
</tbody>
</table>
<p>1つ目が踏み台用、2つ目が本番用という想定です。<br>
それぞれ256個ずつIPアドレスを持つことになります。</p>
<p>アベイラビリティゾーンは東京では <code>ap-northeact-1a</code> <code>ap-northeast-1c</code> の2択ですが、どちらが具体的にどこの場所、というのはなく、仮想ネットワーク毎にAWS側で振り分けられるそうです。<br>
なので、 「 <code>1a</code> は沢山の人が選んで混んでそうだからa <code>1c</code> にしよう」みたいなことは意味がないらしいです。<br>
情報元はどこかのネット記事で読んだのですがどこかへ行ってしまいました。。</p>
<h1>インターネットゲートウェイの作成</h1>
<p>仮想ネットワークをインターネットと繋げる為に、インターネットゲートウェイを作成します。<br>
VPCダッシュボードからインターネットゲートウェイ＞インターネットゲートウェイの作成を選択<br>
<img src="https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/10-create-igw.png" alt="create-igw"><br>
名前は <code>igw-sample</code> としておきます。</p>
<h1>ルートテーブルの作成</h1>
<p>上で作成したインターネットゲートウェイを紐付けるためのルートテーブルを作成します。<br>
ルートテーブル＞ルートテーブルの作成を選択し、 <code>rtb-sample</code> を指定します。<br>
作成後、 <code>0.0.0.0/0</code> (デフォルトゲートウェイとして) インターネットゲートウェイを紐付けます。<br>
<img src="https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/11-create-rtb.png" alt="create-rtb"><br>
さらに、「サブネットの関連付け」で踏み台用のサブネットである <code>subnet-sample-public</code> を紐付けます。</p>
<h1>EC2（踏み台）の作成</h1>
<p>いよいよサーバーです。<br>
サービス＞EC2＞インスタンスから「インスタンスの作成」を選択<br>
<a href="https://aws.amazon.com/jp/blogs/news/amazon-linux-2-release/">ちょうど数日前にリリースされたAmazon Linux 2</a> が無料枠で選べる状態だったので、これを選択します。</p>
<p><img src="https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/5-create-ec2.png" alt="create-ec2-1"></p>
<p><code>t2.micro</code> を選択します。</p>
<p><img src="https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/6-create-ec2.png" alt="create-ec2-2"></p>
<p>インスタンスの詳細設定です。<br>
<img src="https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/7-create-ec2.png" alt="create-ec2-3"></p>
<p>ちょっと項目数が多いのでかいつまんで。</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ネットワーク</td>
<td style="text-align:left">vpc-sample</td>
</tr>
<tr>
<td style="text-align:left">サブネット</td>
<td style="text-align:left">subnet-sample-public</td>
</tr>
<tr>
<td style="text-align:left">自動割り当てパブリックIP</td>
<td style="text-align:left">有効化</td>
</tr>
<tr>
<td style="text-align:left">プライマリIP</td>
<td style="text-align:left">192.168.1.10</td>
</tr>
</tbody>
</table>
<p>ここは若干ハマってしまった所なのですが、プライマリIPを <code>192.168.1.1</code> に指定したら、最後のEC2作成のフェーズでエラーになってしまいました。<br>
プライマリIPは先頭と末尾（<code>192.168.1.0</code> <code>192.168.1.255</code>）だけ避ければ良いと思っていたのですが、他にも <code>192.168.1.1</code> <code>192.168.1.2</code> <code>192.168.1.3</code> は予約済アドレスとなるようです。<br>
プライマリIPはわざわざ指定しなくても良かったかもしれないです。</p>
<p>参考： <a href="http://blog.serverworks.co.jp/tech/2013/05/23/vpc_beginner-2/">VPC初心者がハマりやすいポイントをまとめてみた</a></p>
<p>次はストレージの追加です。<br>
<img src="https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/8-create-ec2.png" alt="create-ec2-4"><br>
デフォルトのまま進めます。<br>
<img src="https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/8-create-tag.png" alt="create-ec2-5"><br>
<code>Name</code> タグに <code>bastion</code> を指定します。</p>
<p><img src="https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/9-create-ec2.png" alt="create-ec2-6"><br>
<img src="https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/9-create-sg.png" alt="create-ec2-7"></p>
<p>「新しいセキュリティグループを作成する」を選択し、セキュリティグループ名を <code>bastion-sg</code> とします。<br>
セキュリティグループの指定で、sshで <code>22</code> をどこからでも受けられるようにします。</p>
<p>「確認と作成」をクリックして、キーペアを作成してダウンロードしたら完了です。</p>
<h1>EC2(本番用)の作成</h1>
<p>ほぼ踏み台と同じなので、違うところだけピックアップします。</p>
<h3>詳細設定</h3>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">サブネット</td>
<td style="text-align:left">subnet-sample-private</td>
</tr>
<tr>
<td style="text-align:left">自動割り当てパブリックIP</td>
<td style="text-align:left">サブネット設定を使用（無効）</td>
</tr>
<tr>
<td style="text-align:left">プライマリIP</td>
<td style="text-align:left">192.168.2.10</td>
</tr>
</tbody>
</table>
<h3>タグ</h3>
<p><code>Name</code> タグに <code>webserver</code> を指定します。</p>
<h3>セキュリティグループ</h3>
<p>「新しいセキュリティグループを作成する」を選択し、セキュリティグループ名を <code>web-sg</code> とします。<br>
セキュリティグループの指定で、sshで <code>22</code> を <code>192.168.1.0/24</code> からのみ受けられるようにします。（ここポイントです）</p>
<h3>キーペア</h3>
<p>踏み台で作成したものと同じものを使うようにします。</p>
<h1>sshログインしてみる</h1>
<p>踏み台→本番への接続も同じキーペアで通せるように、以下のコマンドを打ちます。</p>
<pre><code class="hljs bash">ssh-add {pemファイルのパス}
ssh-add -l <span class="hljs-comment"># 登録できたか確認</span>
</code></pre>
<p>まずは踏み台のログインです。</p>
<pre><code class="hljs bash">ssh -i {pemファイルのパス} ec2-user@{踏み台に割当てられたパブリックIP}
</code></pre>
<p>ログインできたら、本番に指定したプライベートIPを使ってさらにsshログインします。</p>
<pre><code class="hljs bash">$ ssh 192.168.2.10 <span class="hljs-comment"># 本番用に指定したプライベートIP</span>
Last login: Sun Dec 17 06:01:04 2017 from 192.168.1.10

       __|  __|_  )
       _|  (     /   Amazon Linux 2 AMI
      ___|\___|___|

https://aws.amazon.com/amazon-linux-2/
</code></pre>
<p>これでログイン完了です！</p>
<h3>ssh/configの設定</h3>
<p>踏み台を通して1発で本番へログインできるようにするための設定です。<br>
<code>~/.ssh/config</code> に記述します。</p>
<pre><code class="hljs bash">Host {踏み台用の好きな名前}
  HostName {踏み台パブリックIP}
  User ec2-user
  IdentityFile {pemファイルのパス}

Host {本番用の好きな名前}
  HostName {本番用プライベートIP}
  User ec2-user
  IdentityFile {pemファイルのパス}
  ProxyCommand ssh {踏み台用の好きな名前} -W %h:%p
</code></pre>
<p>上記を指定しておけば、 <code>ssh {本番用の好きな名前}</code> でログインできます。</p>
</div><div class="socialButtons"><div class="twitter__Styles-ixfWcN hPFOEi"><a class="button" href="#"><svg fill="currentColor" preserveAspectRatio="xMidYMid meet" height="1em" width="1em" viewBox="0 0 40 40" style="vertical-align:middle"><g><path d="m37.7 9.1q-1.5 2.2-3.7 3.7 0.1 0.3 0.1 1 0 2.9-0.9 5.8t-2.6 5.5-4.1 4.7-5.7 3.3-7.2 1.2q-6.1 0-11.1-3.3 0.8 0.1 1.7 0.1 5 0 9-3-2.4-0.1-4.2-1.5t-2.6-3.5q0.8 0.1 1.4 0.1 1 0 1.9-0.3-2.5-0.5-4.1-2.5t-1.7-4.6v0q1.5 0.8 3.3 0.9-1.5-1-2.4-2.6t-0.8-3.4q0-2 0.9-3.7 2.7 3.4 6.6 5.4t8.3 2.2q-0.2-0.9-0.2-1.7 0-3 2.1-5.1t5.1-2.1q3.2 0 5.3 2.3 2.4-0.5 4.6-1.7-0.8 2.5-3.2 3.9 2.1-0.2 4.2-1.1z"></path></g></svg>Tweet</a></div><a href="http://b.hatena.ne.jp/entry/blog.bakunyo.com/2017/12/17/amazon-vpc/" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-large" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border:none"/></a><a data-pocket-label="pocket" data-pocket-count="vertical" class="pocket-btn" data-lang="ja"></a></div></div></div><div class="Footer__Styles-fSAnuS cZCpqm"><footer><nav><section class="profile"><h3>Profile</h3><div class="self"><img src="/static/bakunyo.f3080bd9.png" alt="bakunyo"/><p><svg fill="currentColor" preserveAspectRatio="xMidYMid meet" height="1em" width="1em" viewBox="0 0 40 40" style="vertical-align:middle"><g><path d="m37.7 9.1q-1.5 2.2-3.7 3.7 0.1 0.3 0.1 1 0 2.9-0.9 5.8t-2.6 5.5-4.1 4.7-5.7 3.3-7.2 1.2q-6.1 0-11.1-3.3 0.8 0.1 1.7 0.1 5 0 9-3-2.4-0.1-4.2-1.5t-2.6-3.5q0.8 0.1 1.4 0.1 1 0 1.9-0.3-2.5-0.5-4.1-2.5t-1.7-4.6v0q1.5 0.8 3.3 0.9-1.5-1-2.4-2.6t-0.8-3.4q0-2 0.9-3.7 2.7 3.4 6.6 5.4t8.3 2.2q-0.2-0.9-0.2-1.7 0-3 2.1-5.1t5.1-2.1q3.2 0 5.3 2.3 2.4-0.5 4.6-1.7-0.8 2.5-3.2 3.9 2.1-0.2 4.2-1.1z"></path></g></svg> <a href="https://twitter.com/bakunyo">@bakunyo</a><br/><br/><span>フリーランスのWEBエンジニアで、 普段は Ruby, JavaScript あたりを書いてます。亀戸に在住。</span></p></div><div class="feedly"><a href="https://cloud.feedly.com/#subscription%2Ffeed%2Fhttp%3A%2F%2Fhttps%3A%2F%2Fblog.bakunyo.com%2Fatom" target="blank"><img id="feedlyFollow" src="https://s3.feedly.com/img/follows/feedly-follow-rectangle-flat-big_2x.png" alt="follow us in feedly" width="131" height="56"/></a></div></section><section class="links"><h3>Tags</h3><ul class="tags"><a href="https://blog.bakunyo.com/tags/aws/"><li>aws</li></a><a href="https://blog.bakunyo.com/tags/blog/"><li>blog</li></a><a href="https://blog.bakunyo.com/tags/css/"><li>css</li></a><a href="https://blog.bakunyo.com/tags/deeplearning/"><li>deeplearning</li></a><a href="https://blog.bakunyo.com/tags/devise/"><li>devise</li></a><a href="https://blog.bakunyo.com/tags/docker/"><li>docker</li></a><a href="https://blog.bakunyo.com/tags/elixir/"><li>elixir</li></a><a href="https://blog.bakunyo.com/tags/encoding/"><li>encoding</li></a><a href="https://blog.bakunyo.com/tags/erlang/"><li>erlang</li></a><a href="https://blog.bakunyo.com/tags/git/"><li>git</li></a><a href="https://blog.bakunyo.com/tags/java/"><li>java</li></a><a href="https://blog.bakunyo.com/tags/jekyll/"><li>jekyll</li></a><a href="https://blog.bakunyo.com/tags/jquery/"><li>jquery</li></a><a href="https://blog.bakunyo.com/tags/linux/"><li>linux</li></a><a href="https://blog.bakunyo.com/tags/middleman/"><li>middleman</li></a><a href="https://blog.bakunyo.com/tags/php/"><li>php</li></a><a href="https://blog.bakunyo.com/tags/python/"><li>python</li></a><a href="https://blog.bakunyo.com/tags/rails/"><li>rails</li></a><a href="https://blog.bakunyo.com/tags/rake/"><li>rake</li></a><a href="https://blog.bakunyo.com/tags/react/"><li>react</li></a><a href="https://blog.bakunyo.com/tags/redux/"><li>redux</li></a><a href="https://blog.bakunyo.com/tags/regex/"><li>regex</li></a><a href="https://blog.bakunyo.com/tags/relay/"><li>relay</li></a><a href="https://blog.bakunyo.com/tags/rspec/"><li>rspec</li></a><a href="https://blog.bakunyo.com/tags/ruby/"><li>ruby</li></a><a href="https://blog.bakunyo.com/tags/security/"><li>security</li></a><a href="https://blog.bakunyo.com/tags/service/"><li>service</li></a><a href="https://blog.bakunyo.com/tags/sql/"><li>sql</li></a><a href="https://blog.bakunyo.com/tags/sublime_text/"><li>sublime_text</li></a><a href="https://blog.bakunyo.com/tags/tensorflow/"><li>tensorflow</li></a><a href="https://blog.bakunyo.com/tags/vim/"><li>vim</li></a><a href="https://blog.bakunyo.com/tags/vpc/"><li>vpc</li></a><a href="https://blog.bakunyo.com/tags/windows/"><li>windows</li></a></ul></section></nav><small>© 2013 - <!-- -->2018<!-- --> <a href="https://twitter.com/bakunyo">@bakunyo</a></small></footer></div></div></div><script type="text/javascript">
                window.__routeData = {"path":"/2017/12/17/amazon-vpc","propsMap":{"__local":"Z1htVJN"},"initialProps":{"post":{"id":43,"path":"/2017/12/17/amazon-vpc/","date":"2017/12/17 13:30","title":"Amazpn VPCで踏み台経由でログインできるネットワーク環境をつくってみる","tags":["aws","vpc"],"body":"<h1>背景</h1>\n<p>個人開発で\b使える\b本番サーバー環境が欲しかったのと、ちょうど仕事でも活かせそうだったので、自分でAWSのネットワーク環境を作ってみました。</p>\n<h1>全体像</h1>\n<p>用意したいサーバーは2つです。</p>\n<ul>\n<li>踏み台\n<ul>\n<li>sshでログインし、さらにsshで本番サーバーへログインするためのもの</li>\n<li>ssh\b\bログイン用のport以外は開けない</li>\n</ul>\n</li>\n<li>\b本番サーバー\n<ul>\n<li>踏み台サーバーからのみsshでログイン可能</li>\n<li>(Webサーバーを予定してるけど、\b今回はhttpのportを開けたりとかしない)</li>\n</ul>\n</li>\n</ul>\n<h1>VPCの作成</h1>\n<p>AWSで管理する仮想ネットワークを定義します。</p>\n<h4>AWSマネジメントコンソールからサービス＞VPCを選択</h4>\n<p><img src=\"https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/1-dashboard.png\" alt=\"vpc-dashboard\"></p>\n<p>既にデフォルトのVPCが定義されていますが、今回は使わずに削除します。</p>\n<h4>「VPCの作成」を選択</h4>\n<p><img src=\"https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/2-create-vpc.png\" alt=\"vpc-create\"></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\"></th>\n<th style=\"text-align:left\"></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Name</td>\n<td style=\"text-align:left\">vpc-sample</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">IPv4 CIDR ブロック</td>\n<td style=\"text-align:left\">192.168.0.0/16</td>\n</tr>\n</tbody>\n</table>\n<p>CIDR ブロックは、仮想ネットワーク内のIPアドレスの範囲を指定します。<br>\n今回は <code>192.168.0.0</code> ~ <code>192.168.255.255</code> で 65,536 個のIPアドレスを持つことになります。<br>\n<a href=\"http://docs.aws.amazon.com/ja_jp/AmazonVPC/latest/UserGuide/VPC_Subnets.html\">VPC とサブネット</a></p>\n<p>CIDRブロックは 16~28の間で指定する必要があるようです。</p>\n<h1>サブネットの作成</h1>\n<p>上で作成したVPCの中でネットワークを小分けにします。</p>\n<h4>VPCダッシュボードの中から「サブネット」を選択</h4>\n<p><img src=\"https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/3-subnet-dashboard.png\" alt=\"subnet-dashboard\"><br>\n「サブネットの作成」を選択し、以下2つのサブネットを作成しました。</p>\n<h4>1つ目</h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\"></th>\n<th style=\"text-align:left\"></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">名前タグ</td>\n<td style=\"text-align:left\">subnet-sample-public</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">VPC</td>\n<td style=\"text-align:left\">{作成\bしたvpc-sampleがデフォルトで選択されている}</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">アベイラビリティゾーン</td>\n<td style=\"text-align:left\">ap-northeast-1a</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">IPv4 CIDR ブロック</td>\n<td style=\"text-align:left\">192.168.1.0/24</td>\n</tr>\n</tbody>\n</table>\n<h4>2つ目</h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\"></th>\n<th style=\"text-align:left\"></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">名前タグ</td>\n<td style=\"text-align:left\">subnet-sample-private</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">VPC</td>\n<td style=\"text-align:left\">{作成\bしたvpc-sampleがデフォルトで選択されている}</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">アベイラビリティゾーン</td>\n<td style=\"text-align:left\">ap-northeast-1a</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">IPv4 CIDR ブロック</td>\n<td style=\"text-align:left\">192.168.2.0/24</td>\n</tr>\n</tbody>\n</table>\n<p>1つ目が踏み台用、2つ目が本番用という想定です。<br>\nそれぞれ256個ずつIPアドレスを持つことになります。</p>\n<p>アベイラビリティゾーンは東京では <code>ap-northeact-1a</code> <code>ap-northeast-1c</code> の2択\bですが、どちらが具体的にどこの場所、というのはなく、仮想ネットワーク毎にAWS側で振り分けられるそうです。<br>\nなので、 「 <code>1a</code> は沢山\bの人が選んで混んでそうだからa <code>1c</code> にしよう」みたいなことは意味がないらしいです。<br>\n\b情報元は\bどこかのネット記事で読んだのですがどこかへ行ってしまいました。。</p>\n<h1>インターネットゲートウェイの作成</h1>\n<p>仮想ネットワークをインターネットと繋げる為に、インターネットゲートウェイを作成します。<br>\nVPCダッシュボードからインターネットゲートウェイ＞インターネットゲートウェイの作成を\b選択<br>\n<img src=\"https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/10-create-igw.png\" alt=\"create-igw\"><br>\n名前は <code>igw-sample</code> としておきます。</p>\n<h1>ルートテーブルの作成</h1>\n<p>\b\b上で作成したインターネットゲートウェイを紐付けるためのルートテーブルを作成します。<br>\nルートテーブル＞ルートテーブルの作成を選択し、 <code>rtb-sample</code> を指定します。<br>\n作成後、 <code>0.0.0.0/0</code> (デフォルトゲートウェイとして) インターネットゲートウェイを紐付けます。<br>\n<img src=\"https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/11-create-rtb.png\" alt=\"create-rtb\"><br>\nさらに、「サブネットの関連付け」で踏み台用のサブネットである <code>subnet-sample-public</code> を紐付けます。</p>\n<h1>EC2（\b踏み台）の作成</h1>\n<p>いよいよサーバーです。<br>\nサービス＞EC2＞インスタンスから「インスタンスの作成」を選択<br>\n<a href=\"https://aws.amazon.com/jp/blogs/news/amazon-linux-2-release/\">ちょうど数日前にリリースされたAmazon Linux 2</a> が無料枠で選べる状態だったので、これを選択します。</p>\n<p><img src=\"https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/5-create-ec2.png\" alt=\"create-ec2-1\"></p>\n<p><code>t2.micro</code> を選択します。</p>\n<p><img src=\"https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/6-create-ec2.png\" alt=\"create-ec2-2\"></p>\n<p>インスタンスの詳細設定です。<br>\n<img src=\"https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/7-create-ec2.png\" alt=\"create-ec2-3\"></p>\n<p>ちょっと項目数が多いのでかいつまんで。</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\"></th>\n<th style=\"text-align:left\"></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">ネットワーク</td>\n<td style=\"text-align:left\">vpc-sample</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">サブネット</td>\n<td style=\"text-align:left\">subnet-sample-public</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">自動割り当てパブリックIP</td>\n<td style=\"text-align:left\">有効化</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">プライマリIP</td>\n<td style=\"text-align:left\">192.168.1.10</td>\n</tr>\n</tbody>\n</table>\n<p>ここは若干ハマってしまった所なのですが、プライマリIPを <code>192.168.1.1</code> に指定したら、最後のEC2作成のフェーズでエラーになってしまいました。<br>\nプライマリIPは先頭と末尾（<code>192.168.1.0</code> <code>192.168.1.255</code>）だけ避ければ良いと思っていたのですが、他にも <code>192.168.1.1</code> <code>192.168.1.2</code> <code>192.168.1.3</code> は予約済アドレスとなるようです。<br>\n\bプライマリIPはわざわざ指定しなくても良かったかもしれないです。</p>\n<p>参考： <a href=\"http://blog.serverworks.co.jp/tech/2013/05/23/vpc_beginner-2/\">VPC初心者がハマりやすいポイントをまとめてみた</a></p>\n<p>次はストレージの追加です。<br>\n<img src=\"https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/8-create-ec2.png\" alt=\"create-ec2-4\"><br>\nデフォルトのまま進めます。<br>\n<img src=\"https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/8-create-tag.png\" alt=\"create-ec2-5\"><br>\n<code>Name</code> タグに <code>bastion</code> を指定します。</p>\n<p><img src=\"https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/9-create-ec2.png\" alt=\"create-ec2-6\"><br>\n<img src=\"https://s3-ap-northeast-1.amazonaws.com/bakunote-images/2017/12/17-amazon-vpc/images/9-create-sg.png\" alt=\"create-ec2-7\"></p>\n<p>「新しいセキュリティグループを作成する」を選択し、セキュリティグループ名を <code>bastion-sg</code> とします。<br>\nセキュリティグループの指定で、sshで <code>22</code> をどこからでも受けられるようにします。</p>\n<p>「確認と作成」をクリックして、キーペアを作成してダウンロードしたら完了です。</p>\n<h1>EC2(本番用)の作成</h1>\n<p>ほぼ踏み台と同じなので、違うところだけピックアップします。</p>\n<h3>詳細設定</h3>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\"></th>\n<th style=\"text-align:left\"></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">サブネット</td>\n<td style=\"text-align:left\">subnet-sample-private</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">自動割り当てパブリックIP</td>\n<td style=\"text-align:left\">サブネット設定を使用（無効）</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">プライマリIP</td>\n<td style=\"text-align:left\">192.168.2.10</td>\n</tr>\n</tbody>\n</table>\n<h3>タグ</h3>\n<p><code>Name</code> タグに <code>webserver</code> を指定します。</p>\n<h3>セキュリティグループ</h3>\n<p>「新しいセキュリティグループを作成する」を選択し、セキュリティグループ名を <code>web-sg</code> とします。<br>\nセキュリティグループの指定で、sshで <code>22</code> を <code>192.168.1.0/24</code> からのみ受けられるようにします。（ここポイントです）</p>\n<h3>キーペア</h3>\n<p>踏み台で作成したものと同じものを使うようにします。</p>\n<h1>sshログインしてみる</h1>\n<p>踏み台→本番への接続も同じキーペアで通せるように、以下のコマンドを打ちます。</p>\n<pre><code class=\"hljs bash\">ssh-add {pemファイルのパス}\nssh-add -l <span class=\"hljs-comment\"># 登録できたか確認</span>\n</code></pre>\n<p>まずは踏み台のログインです。</p>\n<pre><code class=\"hljs bash\">ssh -i {pemファイルのパス} ec2-user@{踏み台に割当てられたパブリックIP}\n</code></pre>\n<p>ログインできたら、\b本番に指定したプライベートIPを使ってさらにsshログインします。</p>\n<pre><code class=\"hljs bash\">$ ssh \b192.168.2.10 <span class=\"hljs-comment\"># 本番用に指定したプライベートIP</span>\nLast login: Sun Dec 17 06:01:04 2017 from 192.168.1.10\n\n       __|  __|_  )\n       _|  (     /   Amazon Linux 2 AMI\n      ___|\\___|___|\n\nhttps://aws.amazon.com/amazon-linux-2/\n</code></pre>\n<p>これでログイン完了です！</p>\n<h3>ssh/configの設定</h3>\n<p>踏み台を通して1発で本番へログインできるようにするための設定です。<br>\n<code>~/.ssh/config</code> に記述します。</p>\n<pre><code class=\"hljs bash\">Host {踏み台用の好きな名前}\n  HostName {踏み台パブリックIP}\n  User ec2-user\n  IdentityFile {pemファイルのパス}\n\nHost {本番用の好きな名前}\n  HostName {本番用プライベートIP}\n  User ec2-user\n  IdentityFile {pemファイルのパス}\n  ProxyCommand ssh {踏み台用の好きな名前} -W %h:%p\n</code></pre>\n<p>上記を指定しておけば、 <code>ssh {本番用の好きな名前}</code> でログインできます。</p>\n"}},"siteProps":{"tagNames":["aws","blog","css","deeplearning","devise","docker","elixir","encoding","erlang","git","java","jekyll","jquery","linux","middleman","php","python","rails","rake","react","redux","regex","relay","rspec","ruby","security","service","sql","sublime_text","tensorflow","vim","vpc","windows"]}};</script><script async="" src="/app.da42d61b.js"></script></body></html>