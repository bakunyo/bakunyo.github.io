<!DOCTYPE html><html lang="ja"><head><meta name="generator" content="React Static"/><title data-react-helmet="true">Amazpn VPCで踏み台経由でログインできるネットワーク環境をつくってみる - BAKUNOTE</title><meta data-react-helmet="true" name="description" content="Amazpn VPCで踏み台経由でログインできるネットワーク環境をつくってみる aws,vpcに関する記事。bakunyoの技術ノート。ruby, javascriptに関することやその他日々の記録です。"/><link rel="preload" as="script" href="https://blog.bakunyo.com/templates/styles.cf147bdf.js"/><link rel="preload" as="script" href="https://blog.bakunyo.com/templates/vendors~main.6d40d334.js"/><link rel="preload" as="script" href="https://blog.bakunyo.com/main.af4bedfd.js"/><link rel="preload" as="style" href="https://blog.bakunyo.com/styles.cf147bdf.css"/><link rel="stylesheet" href="https://blog.bakunyo.com/styles.cf147bdf.css"/><link data-react-helmet="true" rel="canonical" href="https://blog.bakunyo.com/2017/12/17/amazon-vpc/"/><style data-styled="lowDAW pAiGv jSLkou" data-styled-version="4.4.1">
/* sc-component-id: sc-bdVaJa */
.lowDAW a{-webkit-text-decoration:none;text-decoration:none;} .lowDAW .content{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;position:relative;} @media (min-width:750px){.lowDAW main,.lowDAW nav{width:700px;}} .lowDAW main{padding:0 0.8rem;} .lowDAW img{max-width:100%;} .lowDAW .postInfo .postMeta{margin-right:3rem;} .lowDAW .postInfo .postMeta p{margin:0.5rem 0;} .lowDAW .meta{color:#555;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;} .lowDAW .meta svg{margin-right:0.5rem;} .lowDAW .meta ul{margin:0;} .lowDAW ul.tags{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;list-style:none;padding-left:0;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;} .lowDAW ul.tags li{font-size:0.9rem;background:#2199e8;margin:0.2rem;color:#ffffff;padding:0.2rem 0.5rem;border-radius:0.1rem;cursor:pointer;} .lowDAW ul.tags li:first-child{margin-left:0;} .lowDAW ul.tags li:hover{background:#008cba;-webkit-transition:all 0.2s ease-in-out;transition:all 0.2s ease-in-out;}
/* sc-component-id: sc-bwzfXH */
.pAiGv header{width:100%;background:#333333;color:#fff;border-bottom:1px #aaa solid;text-align:center;cursor:pointer;} @media (min-width:750px){.pAiGv header{margin-bottom:1rem;}} .pAiGv header a{color:#ffffff;} .pAiGv header h1{font-weight:normal;margin-bottom:0.3rem;margin-top:0;} @media (min-width:750px){.pAiGv header h1{font-size:2.5rem;padding-top:1rem;}} @media (max-width:750px){.pAiGv header h1{font-size:1.8rem;padding-top:0.5rem;}} @media (max-width:360px){.pAiGv header h1{font-size:1.8rem;padding-top:0.5rem;}} .pAiGv header p{margin-top:0;} @media (min-width:750px){.pAiGv header p{margin-bottom:1rem;}} @media (max-width:750px){.pAiGv header p{font-size:0.8rem;margin-bottom:0.5rem;}} @media (max-width:360px){.pAiGv header p{font-size:0.8rem;margin-bottom:0.5rem;}}
/* sc-component-id: sc-htpNat */
.jSLkou footer{margin-top:1rem;padding:1rem;background:#eee;text-align:center;} .jSLkou footer nav{margin:0 auto;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;margin-bottom:2rem;} .jSLkou footer nav section{text-align:left;margin:0 2rem 1rem 0;-webkit-flex:1;-ms-flex:1;flex:1;} .jSLkou footer nav section.profile div.self{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-bottom:1rem;} .jSLkou footer nav section.profile div.self svg{height:1.5rem;width:1.5rem;} .jSLkou footer nav section.profile div.self img{width:6rem;height:6rem;border-radius:3rem;} .jSLkou footer nav section.profile div.self p{margin:0 0 0 1rem;} .jSLkou footer nav section.links ul.tags{margin:0.6rem 0;} .jSLkou footer nav section.links ul.tags li{margin-left:0.2rem;} @media (max-width:750px){.jSLkou footer nav{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}} @media (max-width:360px){.jSLkou footer nav{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}} .jSLkou footer .footerSmalls span,.jSLkou footer .footerSmalls a{margin:0 0.2rem;}</style><style data-styled="gxmFGK nBDcB PLkoY bgvRAe" data-styled-version="4.4.1">
/* sc-component-id: sc-bxivhb */
.bgvRAe{width:8rem;} @media (max-width:750px){.bgvRAe{display:none;}} @media (max-width:360px){.bgvRAe{display:none;}}
/* sc-component-id: sc-gzVnrw */
.nBDcB a.button{display:block;padding:0.5rem 1rem;color:#fefefe;background:#1583cc;width:3rem;text-align:center;border-radius:0.2rem;font-size:0.9rem;} .nBDcB a.button svg{font-size:1.5rem;}
/* sc-component-id: sc-htoDjs */
.PLkoY h1{font-size:1.5rem;font-size:1.5rem;} @media (min-width:750px){.PLkoY h1{font-size:2.5rem;}} .PLkoY .postInfo{background:#f3f3f3;padding:1rem;} @media (min-width:750px){.PLkoY .postInfo{margin-bottom:3rem;}} @media (max-width:750px){.PLkoY .postInfo{margin-bottom:1rem;}} @media (max-width:360px){.PLkoY .postInfo{margin-bottom:1rem;}} .PLkoY .socialButtons{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;} @media (min-width:750px){.PLkoY .socialButtons{display:none;}} .PLkoY .socialButtons div,.PLkoY .socialButtons iframe{margin-right:0.5rem;} .PLkoY .postContent{margin-bottom:5rem;} @media (min-width:750px){.PLkoY .postContent h2{font-size:1.8rem;margin-top:4rem;}.PLkoY .postContent h3{font-size:1.6rem;margin-top:3rem;}.PLkoY .postContent h4{font-size:1.4rem;margin-top:2rem;}.PLkoY .postContent h5{font-size:1.3rem;}} @media (max-width:750px){.PLkoY .postContent h2{font-size:1.3rem;margin-top:3rem;}.PLkoY .postContent h3{font-size:1.2rem;margin-top:2rem;}.PLkoY .postContent h4{font-size:1.1rem;margin-top:1.5rem;}.PLkoY .postContent h5{font-size:1rem;}} @media (max-width:360px){.PLkoY .postContent h2{font-size:1.3rem;margin-top:3rem;}.PLkoY .postContent h3{font-size:1.2rem;margin-top:2rem;}.PLkoY .postContent h4{font-size:1.1rem;margin-top:1.5rem;}.PLkoY .postContent h5{font-size:1rem;}} .PLkoY .postContent ul.tags{margin:0.5rem 0;} .PLkoY .postContent h2{padding-bottom:0.5rem;border-bottom:1px #ccc solid;} .PLkoY .postContent blockquote{font-size:1.3rem;font-style:italic;color:#aaa;border-top:1px #ccc solid;border-bottom:1px #ccc solid;width:95%;margin:2.5rem 0;} .PLkoY .postContent pre{margin:2rem 0;} @media (max-width:750px){.PLkoY .postContent pre{width:95vw;overflow:scroll;}} @media (max-width:360px){.PLkoY .postContent pre{width:95vw;overflow:scroll;}} .PLkoY .postContent pre div.file{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;} .PLkoY .postContent pre div.file div.text{padding:0.3rem 0.6rem;font-size:0.8rem;background:#555;border-radius:0.2rem 0.2rem 0 0;color:#ffffff;} .PLkoY .postContent pre code{padding:1.2rem;} .PLkoY .postContent p > code{background:#eaeaea;padding:0 0.4rem;border-radius:0.1rem;} .PLkoY .postContent table{border-collapse:collapse;} @media (max-width:750px){.PLkoY .postContent table{table-layout:fixed;width:95vw;}} @media (max-width:360px){.PLkoY .postContent table{table-layout:fixed;width:95vw;}} .PLkoY .postContent table th,.PLkoY .postContent table td{overflow:auto;} .PLkoY .postContent table th[style="text-align:right"]{display:none;} .PLkoY .postContent table td[style="text-align:right"]{text-align:left !important;} .PLkoY .postContent table th{background:#555;color:#fff;border:1px #ccc solid;padding:1rem 0.8rem;} .PLkoY .postContent table td{border:1px #ccc solid;padding:0.8rem;} .PLkoY .postContent ul,.PLkoY .postContent ol{font-size:1.1rem;} .PLkoY .postContent ul li,.PLkoY .postContent ol li{margin-bottom:0.3rem;} .PLkoY .postContent hr{margin:3rem 0;} .PLkoY .postContent p{font-size:1.1rem;} .PLkoY .postContent a{word-break:break-all;} .PLkoY .postContent .cstmreba{margin:2rem 0;} .PLkoY .postContent .cstmreba .kaerebalink-box{border:1px #ccc solid;background:#ececec;padding:1.5rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;} .PLkoY .postContent .cstmreba .kaerebalink-box .kaerebalink-info{margin-left:2rem;} .PLkoY .postContent .cstmreba .kaerebalink-box .kaerebalink-info .kaerebalink-name > a{font-size:1.2rem;} .PLkoY .postContent .cstmreba .kaerebalink-box img{margin:0;} .PLkoY .postContent twitter-widget{width:95vw !important;}
/* sc-component-id: sc-dnqmqq */
.gxmFGK{margin-top:2.5rem;width:8rem;position:relative;} @media (max-width:750px){.gxmFGK{display:none;}} @media (max-width:360px){.gxmFGK{display:none;}} .gxmFGK .socialLinks{position:-webkit-sticky;position:sticky;top:2rem;} .gxmFGK .socialLinks div,.gxmFGK .socialLinks iframe{margin-bottom:0.5rem;}</style><meta charSet="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="icon" href="https://blog.bakunyo.com/favicon.ico"/><link rel="altarnate" type="application/rss+xml" title="sitemap" href="https://blog.bakunyo.com/sitemap.xml"/><meta name="theme-color" content="#333333"/><meta name="google-site-verification" content="TIEG3i45Tk7IaRrKnwB69GBid55VwIZwcvkRQRAakgY"/></head><body><div id="root"><div style="outline:none" tabindex="-1" role="group"><div class="sc-bdVaJa lowDAW"><div class="sc-bwzfXH pAiGv"><header><a href="https://blog.bakunyo.com/"><h1>BAKUNOTE</h1><p>bakunyoの技術ノート</p></a></header></div><div style="outline:none" tabindex="-1" role="group"><div class="content"><div class="sc-dnqmqq gxmFGK"><div class="socialLinks"><div class="sc-gzVnrw nBDcB"><a class="button" href="#"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg>Tweet</a></div><a href="httpsb.hatena.ne.jp/entry/httpsblog.bakunyo.com/2017/12/17/amazon-vpc/" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-large" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border:none"/></a><a data-pocket-label="pocket" data-pocket-count="vertical" class="pocket-btn" data-lang="ja"></a></div></div><main class="sc-htoDjs PLkoY"><h1>Amazpn VPCで踏み台経由でログインできるネットワーク環境をつくってみる</h1><div class="postInfo"><div class="postMeta"><div class="meta"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M12 192h424c6.6 0 12 5.4 12 12v260c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V204c0-6.6 5.4-12 12-12zm436-44v-36c0-26.5-21.5-48-48-48h-48V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H160V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H48C21.5 64 0 85.5 0 112v36c0 6.6 5.4 12 12 12h424c6.6 0 12-5.4 12-12z"></path></svg><span>2017/12/17 13:30</span></div><div class="meta"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 640 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M497.941 225.941L286.059 14.059A48 48 0 0 0 252.118 0H48C21.49 0 0 21.49 0 48v204.118a48 48 0 0 0 14.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882 0l204.118-204.118c18.745-18.745 18.745-49.137 0-67.882zM112 160c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882 0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397 0h48.721a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882z"></path></svg><ul class="tags"><a href="https://blog.bakunyo.com/tags/aws/"><li>aws</li></a><a href="https://blog.bakunyo.com/tags/vpc/"><li>vpc</li></a></ul></div></div></div><div class="socialButtons"><div class="sc-gzVnrw nBDcB"><a class="button" href="#"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg>Tweet</a></div><a href="httpsb.hatena.ne.jp/entry/httpsblog.bakunyo.com/2017/12/17/amazon-vpc/" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-large" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border:none"/></a><a data-pocket-label="pocket" data-pocket-count="vertical" class="pocket-btn" data-lang="ja"></a></div><div class="postContent"><h1>背景</h1><p>個人開発で使える本番サーバー環境が欲しかったのと、ちょうど仕事でも活かせそうだったので、自分でAWSのネットワーク環境を作ってみました。</p><h1>全体像</h1><p>用意したいサーバーは2つです。</p><ul><li>踏み台<ul><li>sshでログインし、さらにsshで本番サーバーへログインするためのもの</li><li>sshログイン用のport以外は開けない</li></ul></li><li>本番サーバー<ul><li>踏み台サーバーからのみsshでログイン可能</li><li>(Webサーバーを予定してるけど、今回はhttpのportを開けたりとかしない)</li></ul></li></ul><h1>VPCの作成</h1><p>AWSで管理する仮想ネットワークを定義します。</p><h4>AWSマネジメントコンソールからサービス＞VPCを選択</h4><p><img src="https://blog.bakunyo.com/2017/12/17-amazon-vpc/images/1-dashboard.png" alt="vpc-dashboard"/></p><p>既にデフォルトのVPCが定義されていますが、今回は使わずに削除します。</p><h4>「VPCの作成」を選択</h4><p><img src="https://blog.bakunyo.com/2017/12/17-amazon-vpc/images/2-create-vpc.png" alt="vpc-create"/></p><table><thead><tr><th align="left"></th><th align="left"></th></tr></thead><tbody><tr><td align="left">Name</td><td align="left">vpc-sample</td></tr><tr><td align="left">IPv4 CIDR ブロック</td><td align="left">192.168.0.0/16</td></tr></tbody></table><p>CIDR ブロックは、仮想ネットワーク内のIPアドレスの範囲を指定します。<br/>
<!-- -->今回は <code>192.168.0.0</code> ~ <code>192.168.255.255</code> で 65,536 個のIPアドレスを持つことになります。<br/>
<a href="http://docs.aws.amazon.com/ja_jp/AmazonVPC/latest/UserGuide/VPC_Subnets.html">VPC とサブネット</a></p><p>CIDRブロックは 16~28の間で指定する必要があるようです。</p><h1>サブネットの作成</h1><p>上で作成したVPCの中でネットワークを小分けにします。</p><h4>VPCダッシュボードの中から「サブネット」を選択</h4><p><img src="https://blog.bakunyo.com/2017/12/17-amazon-vpc/images/3-subnet-dashboard.png" alt="subnet-dashboard"/>
「サブネットの作成」を選択し、以下2つのサブネットを作成しました。</p><h4>1つ目</h4><table><thead><tr><th align="left"></th><th align="left"></th></tr></thead><tbody><tr><td align="left">名前タグ</td><td align="left">subnet-sample-public</td></tr><tr><td align="left">VPC</td><td align="left">{作成したvpc-sampleがデフォルトで選択されている}</td></tr><tr><td align="left">アベイラビリティゾーン</td><td align="left">ap-northeast-1a</td></tr><tr><td align="left">IPv4 CIDR ブロック</td><td align="left">192.168.1.0/24</td></tr></tbody></table><h4>2つ目</h4><table><thead><tr><th align="left"></th><th align="left"></th></tr></thead><tbody><tr><td align="left">名前タグ</td><td align="left">subnet-sample-private</td></tr><tr><td align="left">VPC</td><td align="left">{作成したvpc-sampleがデフォルトで選択されている}</td></tr><tr><td align="left">アベイラビリティゾーン</td><td align="left">ap-northeast-1a</td></tr><tr><td align="left">IPv4 CIDR ブロック</td><td align="left">192.168.2.0/24</td></tr></tbody></table><p>1つ目が踏み台用、2つ目が本番用という想定です。
それぞれ256個ずつIPアドレスを持つことになります。</p><p>アベイラビリティゾーンは東京では <code>ap-northeact-1a</code> <code>ap-northeast-1c</code> の2択ですが、どちらが具体的にどこの場所、というのはなく、仮想ネットワーク毎にAWS側で振り分けられるそうです。
なので、 「 <code>1a</code> は沢山の人が選んで混んでそうだからa <code>1c</code> にしよう」みたいなことは意味がないらしいです。
情報元はどこかのネット記事で読んだのですがどこかへ行ってしまいました。。</p><h1>インターネットゲートウェイの作成</h1><p>仮想ネットワークをインターネットと繋げる為に、インターネットゲートウェイを作成します。
VPCダッシュボードからインターネットゲートウェイ＞インターネットゲートウェイの作成を選択
<img src="https://blog.bakunyo.com/2017/12/17-amazon-vpc/images/10-create-igw.png" alt="create-igw"/>
名前は <code>igw-sample</code> としておきます。</p><h1>ルートテーブルの作成</h1><p>上で作成したインターネットゲートウェイを紐付けるためのルートテーブルを作成します。
ルートテーブル＞ルートテーブルの作成を選択し、 <code>rtb-sample</code> を指定します。
作成後、 <code>0.0.0.0/0</code> (デフォルトゲートウェイとして) インターネットゲートウェイを紐付けます。
<img src="https://blog.bakunyo.com/2017/12/17-amazon-vpc/images/11-create-rtb.png" alt="create-rtb"/>
さらに、「サブネットの関連付け」で踏み台用のサブネットである <code>subnet-sample-public</code> を紐付けます。</p><h1>EC2（踏み台）の作成</h1><p>いよいよサーバーです。
サービス＞EC2＞インスタンスから「インスタンスの作成」を選択<br/>
<a href="https://aws.amazon.com/jp/blogs/news/amazon-linux-2-release/">ちょうど数日前にリリースされたAmazon Linux 2</a> が無料枠で選べる状態だったので、これを選択します。</p><p><img src="https://blog.bakunyo.com/2017/12/17-amazon-vpc/images/5-create-ec2.png" alt="create-ec2-1"/></p><p><code>t2.micro</code> を選択します。</p><p><img src="https://blog.bakunyo.com/2017/12/17-amazon-vpc/images/6-create-ec2.png" alt="create-ec2-2"/></p><p>インスタンスの詳細設定です。
<img src="https://blog.bakunyo.com/2017/12/17-amazon-vpc/images/7-create-ec2.png" alt="create-ec2-3"/></p><p>ちょっと項目数が多いのでかいつまんで。</p><table><thead><tr><th align="left"></th><th align="left"></th></tr></thead><tbody><tr><td align="left">ネットワーク</td><td align="left">vpc-sample</td></tr><tr><td align="left">サブネット</td><td align="left">subnet-sample-public</td></tr><tr><td align="left">自動割り当てパブリックIP</td><td align="left">有効化</td></tr><tr><td align="left">プライマリIP</td><td align="left">192.168.1.10</td></tr></tbody></table><p>ここは若干ハマってしまった所なのですが、プライマリIPを <code>192.168.1.1</code> に指定したら、最後のEC2作成のフェーズでエラーになってしまいました。<br/>
<!-- -->プライマリIPは先頭と末尾（<code>192.168.1.0</code> <code>192.168.1.255</code>）だけ避ければ良いと思っていたのですが、他にも <code>192.168.1.1</code> <code>192.168.1.2</code> <code>192.168.1.3</code> は予約済アドレスとなるようです。<br/>
<!-- -->プライマリIPはわざわざ指定しなくても良かったかもしれないです。</p><p>参考： <a href="http://blog.serverworks.co.jp/tech/2013/05/23/vpc_beginner-2/">VPC初心者がハマりやすいポイントをまとめてみた</a></p><p>次はストレージの追加です。
<img src="https://blog.bakunyo.com/2017/12/17-amazon-vpc/images/8-create-ec2.png" alt="create-ec2-4"/>
デフォルトのまま進めます。
<img src="https://blog.bakunyo.com/2017/12/17-amazon-vpc/images/8-create-tag.png" alt="create-ec2-5"/>
<code>Name</code> タグに <code>bastion</code> を指定します。</p><p><img src="https://blog.bakunyo.com/2017/12/17-amazon-vpc/images/9-create-ec2.png" alt="create-ec2-6"/>
<img src="https://blog.bakunyo.com/2017/12/17-amazon-vpc/images/9-create-sg.png" alt="create-ec2-7"/></p><p>「新しいセキュリティグループを作成する」を選択し、セキュリティグループ名を <code>bastion-sg</code> とします。
セキュリティグループの指定で、sshで <code>22</code> をどこからでも受けられるようにします。</p><p>「確認と作成」をクリックして、キーペアを作成してダウンロードしたら完了です。</p><h1>EC2(本番用)の作成</h1><p>ほぼ踏み台と同じなので、違うところだけピックアップします。</p><h3>詳細設定</h3><table><thead><tr><th align="left"></th><th align="left"></th></tr></thead><tbody><tr><td align="left">サブネット</td><td align="left">subnet-sample-private</td></tr><tr><td align="left">自動割り当てパブリックIP</td><td align="left">サブネット設定を使用（無効）</td></tr><tr><td align="left">プライマリIP</td><td align="left">192.168.2.10</td></tr></tbody></table><h3>タグ</h3><p><code>Name</code> タグに <code>webserver</code> を指定します。</p><h3>セキュリティグループ</h3><p>「新しいセキュリティグループを作成する」を選択し、セキュリティグループ名を <code>web-sg</code> とします。
セキュリティグループの指定で、sshで <code>22</code> を <code>192.168.1.0/24</code> からのみ受けられるようにします。（ここポイントです）</p><h3>キーペア</h3><p>踏み台で作成したものと同じものを使うようにします。</p><h1>sshログインしてみる</h1><p>踏み台→本番への接続も同じキーペアで通せるように、以下のコマンドを打ちます。</p><pre><code class="hljs language-bash">ssh-add {pemファイルのパス}
ssh-add -l <span class="hljs-comment"># 登録できたか確認</span></code></pre><p>まずは踏み台のログインです。</p><pre><code class="hljs language-bash">ssh -i {pemファイルのパス} ec2-user@{踏み台に割当てられたパブリックIP}</code></pre><p>ログインできたら、本番に指定したプライベートIPを使ってさらにsshログインします。</p><pre><code class="hljs language-bash">$ ssh 192.168.2.10 <span class="hljs-comment"># 本番用に指定したプライベートIP</span>
Last login: Sun Dec 17 06:01:04 2017 from 192.168.1.10

       __|  __|_  )
       _|  (     /   Amazon Linux 2 AMI
      ___|\___|___|

https://aws.amazon.com/amazon-linux-2/</code></pre><p>これでログイン完了です！</p><h3>ssh/configの設定</h3><p>踏み台を通して1発で本番へログインできるようにするための設定です。
<code>~/.ssh/config</code> に記述します。</p><pre><code class="hljs language-bash">Host {踏み台用の好きな名前}
  HostName {踏み台パブリックIP}
  User ec2-user
  IdentityFile {pemファイルのパス}

Host {本番用の好きな名前}
  HostName {本番用プライベートIP}
  User ec2-user
  IdentityFile {pemファイルのパス}
  ProxyCommand ssh {踏み台用の好きな名前} -W %h:%p</code></pre><p>上記を指定しておけば、 <code>ssh {本番用の好きな名前}</code> でログインできます。</p></div><div class="socialButtons bottom"><div class="sc-gzVnrw nBDcB"><a class="button" href="#"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg>Tweet</a></div><a href="httpsb.hatena.ne.jp/entry/httpsblog.bakunyo.com/2017/12/17/amazon-vpc/" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-large" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border:none"/></a><a data-pocket-label="pocket" data-pocket-count="vertical" class="pocket-btn" data-lang="ja"></a></div></main><div class="sc-bxivhb bgvRAe"></div></div></div><div class="sc-htpNat jSLkou"><footer><nav><section class="profile"><h3>Profile</h3><div class="self"><img src="https://blog.bakunyo.com/images/bakunyo.png" alt="bakunyo"/><p><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg> <a href="https://twitter.com/bakunyo">@bakunyo</a><br/><br/><span><a href="https://itta.llc/">合同会社ITTA</a> 代表社員。普段は Rails / React / TypeScript あたりを書いてます。 お仕事の話あれば気軽に連絡ください。</span></p></div><div class="feedly"><a href="https://feedly.com/i/subscription/feed/https://blog.bakunyo.com/rss" target="blank"><img id="feedlyFollow" src="https://s3.feedly.com/img/follows/feedly-follow-rectangle-flat-big_2x.png" alt="follow us in feedly" width="131" height="56"/></a></div></section><section class="links"><h3>Tags</h3><ul class="tags"><a href="https://blog.bakunyo.com/tags/LT/"><li>LT</li></a><a href="https://blog.bakunyo.com/tags/amp/"><li>amp</li></a><a href="https://blog.bakunyo.com/tags/architecture/"><li>architecture</li></a><a href="https://blog.bakunyo.com/tags/aws/"><li>aws</li></a><a href="https://blog.bakunyo.com/tags/blog/"><li>blog</li></a><a href="https://blog.bakunyo.com/tags/camp/"><li>camp</li></a><a href="https://blog.bakunyo.com/tags/css/"><li>css</li></a><a href="https://blog.bakunyo.com/tags/deeplearning/"><li>deeplearning</li></a><a href="https://blog.bakunyo.com/tags/devise/"><li>devise</li></a><a href="https://blog.bakunyo.com/tags/docker/"><li>docker</li></a><a href="https://blog.bakunyo.com/tags/elixir/"><li>elixir</li></a><a href="https://blog.bakunyo.com/tags/encoding/"><li>encoding</li></a><a href="https://blog.bakunyo.com/tags/erlang/"><li>erlang</li></a><a href="https://blog.bakunyo.com/tags/git/"><li>git</li></a><a href="https://blog.bakunyo.com/tags/github/"><li>github</li></a><a href="https://blog.bakunyo.com/tags/golang/"><li>golang</li></a><a href="https://blog.bakunyo.com/tags/java/"><li>java</li></a><a href="https://blog.bakunyo.com/tags/javascript/"><li>javascript</li></a><a href="https://blog.bakunyo.com/tags/jekyll/"><li>jekyll</li></a><a href="https://blog.bakunyo.com/tags/jquery/"><li>jquery</li></a><a href="https://blog.bakunyo.com/tags/linux/"><li>linux</li></a><a href="https://blog.bakunyo.com/tags/markdown/"><li>markdown</li></a><a href="https://blog.bakunyo.com/tags/middleman/"><li>middleman</li></a><a href="https://blog.bakunyo.com/tags/php/"><li>php</li></a><a href="https://blog.bakunyo.com/tags/python/"><li>python</li></a><a href="https://blog.bakunyo.com/tags/rails/"><li>rails</li></a><a href="https://blog.bakunyo.com/tags/rake/"><li>rake</li></a><a href="https://blog.bakunyo.com/tags/react/"><li>react</li></a><a href="https://blog.bakunyo.com/tags/react-static/"><li>react-static</li></a><a href="https://blog.bakunyo.com/tags/reading/"><li>reading</li></a><a href="https://blog.bakunyo.com/tags/redux/"><li>redux</li></a><a href="https://blog.bakunyo.com/tags/regex/"><li>regex</li></a><a href="https://blog.bakunyo.com/tags/relay/"><li>relay</li></a><a href="https://blog.bakunyo.com/tags/rspec/"><li>rspec</li></a><a href="https://blog.bakunyo.com/tags/ruby/"><li>ruby</li></a><a href="https://blog.bakunyo.com/tags/rust/"><li>rust</li></a><a href="https://blog.bakunyo.com/tags/sauna/"><li>sauna</li></a><a href="https://blog.bakunyo.com/tags/security/"><li>security</li></a><a href="https://blog.bakunyo.com/tags/service/"><li>service</li></a><a href="https://blog.bakunyo.com/tags/sql/"><li>sql</li></a><a href="https://blog.bakunyo.com/tags/sublime_text/"><li>sublime_text</li></a><a href="https://blog.bakunyo.com/tags/tensorflow/"><li>tensorflow</li></a><a href="https://blog.bakunyo.com/tags/test/"><li>test</li></a><a href="https://blog.bakunyo.com/tags/tool/"><li>tool</li></a><a href="https://blog.bakunyo.com/tags/typescript/"><li>typescript</li></a><a href="https://blog.bakunyo.com/tags/vim/"><li>vim</li></a><a href="https://blog.bakunyo.com/tags/vpc/"><li>vpc</li></a><a href="https://blog.bakunyo.com/tags/windows/"><li>windows</li></a></ul></section></nav><small class="footerSmalls"><a href="https://twitter.com/bakunyo">@bakunyo</a><span>© 2013 - <!-- -->2020<!-- --> </span><a href="https://blog.bakunyo.com/privacy/">プライバシーポリシー</a></small></footer></div></div></div></div><script type="text/javascript">
    window.__routeInfo = JSON.parse("{\"template\":\"/Users/bakunyo/go/src/github.com/bakunyo/bakunote/src/articles/2017/12/17-amazon-vpc/index.tsx\",\"sharedHashesByProp\":{},\"data\":{\"post\":{\"date\":\"2017/12/17 13:30\",\"title\":\"Amazpn VPC\u3067\u8E0F\u307F\u53F0\u7D4C\u7531\u3067\u30ED\u30B0\u30A4\u30F3\u3067\u304D\u308B\u30CD\u30C3\u30C8\u30EF\u30FC\u30AF\u74B0\u5883\u3092\u3064\u304F\u3063\u3066\u307F\u308B\",\"tags\":[\"aws\",\"vpc\"],\"temp\":\"./src/articles/2017/12/17-amazon-vpc/index.tsx\",\"path\":\"/2017/12/17/amazon-vpc/\"}},\"path\":\"2017/12/17/amazon-vpc\",\"sharedData\":{},\"siteData\":{\"tags\":[\"LT\",\"amp\",\"architecture\",\"aws\",\"blog\",\"camp\",\"css\",\"deeplearning\",\"devise\",\"docker\",\"elixir\",\"encoding\",\"erlang\",\"git\",\"github\",\"golang\",\"java\",\"javascript\",\"jekyll\",\"jquery\",\"linux\",\"markdown\",\"middleman\",\"php\",\"python\",\"rails\",\"rake\",\"react\",\"react-static\",\"reading\",\"redux\",\"regex\",\"relay\",\"rspec\",\"ruby\",\"rust\",\"sauna\",\"security\",\"service\",\"sql\",\"sublime_text\",\"tensorflow\",\"test\",\"tool\",\"typescript\",\"vim\",\"vpc\",\"windows\"]}}");</script><script defer="" type="text/javascript" src="https://blog.bakunyo.com/templates/styles.cf147bdf.js"></script><script defer="" type="text/javascript" src="https://blog.bakunyo.com/templates/vendors~main.6d40d334.js"></script><script defer="" type="text/javascript" src="https://blog.bakunyo.com/main.af4bedfd.js"></script></body></html>