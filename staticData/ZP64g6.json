{"post":{"id":46,"path":"/2018/06/22/open-uri-use-tempfile/","date":"2018/06/22 15:57","title":"Rubyのopen-uriで常にTempfileを取得する","description":"rubyのopen-uriはStringIOもしくはTempfileのどちらかが開くので、Tempfileを常に取得するためのコードを書きました。","tags":["ruby"],"body":"<p><a href=\"https://docs.ruby-lang.org/ja/latest/library/open=2duri.html\">open-uri</a>のドキュメントより、</p>\n<blockquote>\n<p>開いたファイルオブジェクトは StringIO もしくは Tempfile ですが</p>\n</blockquote>\n<p>とある。<br>\n取得したファイルサイズによって返るオブジェクトの型が変わるらしい。</p>\n<p>常に <code>Tempfile</code> を取得したかったので、以下のようにブロックの中で <code>Tempfile</code> を作って対応した。</p>\n<pre><code class=\"hljs ruby\"><span class=\"hljs-keyword\">require</span> <span class=\"hljs-string\">'open-uri'</span>\n\nopen(url) <span class=\"hljs-keyword\">do</span> <span class=\"hljs-params\">|f|</span>\n  Tempfile.open <span class=\"hljs-keyword\">do</span> <span class=\"hljs-params\">|tmp|</span>\n    tmp.binmode\n    tmp.write f.read\n    tmp.rewind\n\n    <span class=\"hljs-comment\"># tmp を使う</span>\n  <span class=\"hljs-keyword\">end</span>\n<span class=\"hljs-keyword\">end</span>\n</code></pre>\n<h3>参考</h3>\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/10496874/why-does-openuri-treat-files-under-10kb-in-size-as-stringio\">Why does OpenURI treat files under 10kb in size as StringIO?</a></li>\n<li><a href=\"https://qiita.com/pujyo3/items/96c680a156405b8cd442\">Rubyのopen_uriでファイルオブジェクトがTempfileになる瞬間を追った</a></li>\n</ul>\n"}}