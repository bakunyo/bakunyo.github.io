{"post":{"id":36,"path":"/2016/05/06/rake_rspec/","date":"2016/05/06 00:00","title":"rspec_rake っていうGemをつくってみた","tags":["rspec","rake"],"body":"<p>人生初のGemをつくってみました！<br>\n<a href=\"https://rubygems.org/gems/rspec_rake\">rspec_rake</a></p>\n<h1>背景</h1>\n<p>Rakeタスクのテスト(RSpec)を書く時に躓くことが多く、そこを楽にできたらいいなーと思ったのがきっかけです。あとそろそろGemつくってみたかった。</p>\n<h1>使い方</h1>\n<p>仮に、</p>\n<ul>\n<li>Railsプロジェクト</li>\n<li>Rakeファイルは<code>lib/tasks</code>以下に入ってる</li>\n</ul>\n<p>という想定だと、以下のような感じで設定します。</p>\n<pre><code class=\"hljs \"># in spec/rails_helper.rb\n\nRSpecRake.configure do |config|\n  config.require_tasks(File.join(Rails.root, 'lib', 'tasks'))\n  config.auto_reenable = true\nend\n</code></pre>\n<p><code>.require_tasks</code>はRakeタスク定義してるだけなので、他の方法でも良いです。<br>\nどちらかと言うと、<code>.auto_reenable</code>の方が欲しい機能でした。</p>\n<h1>auto_reenable</h1>\n<p><a href=\"http://qiita.com/morygonzalez/items/699749c631f66e62637b\">Rake タスクをテストコードの中で複数回実行する</a><br>\nこちらの記事に書かれているように、Rakeタスクの<code>#invoke</code>メソッドを2回以上実行する時は、その都度<code>#reenable</code>メソッドを呼ぶ必要があります。<br>\nここではテストなので、成功パターン・失敗パターンだけでも2回以上実行することになりますよね…！</p>\n<p>で、毎度<code>#reenable</code>を呼ぶのは面倒なので、</p>\n<pre><code class=\"hljs \">  config.auto_reenable = true\n</code></pre>\n<p>と設定すれば、タスク実行後に自動的に<code>#reenable</code>するようにしました。</p>\n<p><strong>但し、タスク内で別のタスクを呼んだりなど、無限ループするような書き方には注意です！</strong></p>\n<p>ちなみに、<code>#execute</code>メソッドなら何度でも実行できて楽なのですが、こっちはこっちでタスクに引数が渡しづらいという悩みが出てきたりします笑</p>\n<h1>specファイル内でのタスク実行方法</h1>\n<p>上記の設定ができていれば、specファイル内では<code>Rake::Task</code>から対象のタスクを呼ぶだけでOKです。</p>\n<pre><code class=\"hljs \"># before, it, afterなどどこでも\nRake::Task['some:task'].invoke\n</code></pre>\n<p>各specファイルではRakeの定義などは要らないし、どのタスクでも呼べるので結構楽に書けると思います。</p>\n<h1>懸念点</h1>\n<p>RSpec起動時にすべてのRakeファイルを読み込む想定なので、テストの実行時間が増えるかもしれないです。<br>\n色んなプロジェクトで試したりとかしてないので、やってみてどうだったとか感想もらえると嬉しいです！</p>\n<h1>参考にした記事</h1>\n<p><a href=\"https://robots.thoughtbot.com/test-rake-tasks-like-a-boss\">Test Rake Tasks Like a BOSS</a><br>\n<a href=\"http://dev.classmethod.jp/server-side/ruby-on-rails/ruby-on-rails_rspec_rake_test/\">[Ruby on Rails]RSpecによるRakeのテスト</a><br>\n<a href=\"http://qiita.com/morygonzalez/items/699749c631f66e62637b\">Rake タスクをテストコードの中で複数回実行する</a><br>\n<a href=\"http://morizyun.github.io/blog/ruby-gem-easy-publish-library-rails/\">RubyGemはめっちゃ簡単に作れる！</a></p>\n"}}