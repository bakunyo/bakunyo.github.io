{"post":{"id":11,"path":"/2013/04/24/action_mailer/","date":"2013/04/24 09:00","title":"RailsのActionMailerを使いGmail経由でメール送信する","tags":["rails"],"body":"<p><a href=\"http://d.hatena.ne.jp/keyword/Rails\">Rails</a>のバージョンは3.2。</p>\n<p>以前は<a href=\"http://d.hatena.ne.jp/keyword/tls\">tls</a>用のライブラリを自前で用意しなきゃいけなかったり大変だったみたいですが、現在はとても簡単になっています。</p>\n<h3>1.設定</h3>\n<p>まずは設定ファイルを編集します。</p>\n<pre class=\"code\" data-unlink=\"\">\nconfig/environments/development.rb\n\nconfig.action_mailer.delivery_method = :smtp\nconfig.action_mailer.raise_delivery_errors = true \nconfig.action_mailer.smtp_settings = {\n  :address => 'smtp.gmail.com',\n  :port => 587,\n  :authentication => :login,\n  :user_name => 'username', # ユーザー名\n  :password => 'password' # パスワード\n}\n</pre>\n<h3>2.Mailerを生成</h3>\n<p><a href=\"http://d.hatena.ne.jp/keyword/rails\">rails</a>コマンドで生成できます。</p>\n<pre class=\"code\" data-unlink=\"\">\nrails generate TestMailer sendmail\n</pre>\n<h3>3.Mailerを編集</h3>\n<p>2で生成したMailerを編集します。</p>\n<pre class=\"code\" data-unlink=\"\">\napp/mailer/test_mailer.rb\n\n# coding: utf-8\nclass TestMailer < ActionMailer::Base\n  default from: \"xxxxxx@gmail.com\"\n\n  # Subject can be set in your I18n file at config/locales/en.yml\n  # with the following lookup:\n  #\n  #   en.test_mailer.sendmail.subject\n  #\n  def sendmail\n    @greeting = \"Hi\"\n\n    mail(:to => \"xxxxxx@gmail.com\",\n   :subject => 'テスト送信')\n  end\nend\n</pre>\n<p>通常のコントローラーと同じように、テンプレート変数などをセット可能。</p>\n<h3>4.メール本文を編集</h3>\n<p>ビュー編集(erb)と同じです。2で自動的にerbファイルも生成されるはず。<br>\nhtmlにしたければ、拡張子を変更。</p>\n<pre class=\"code\" data-unlink=\"\">\napp/views/test_mailer/sendmail.text.erb\n\n中身は自由に。\n</pre>\n<h3>5.Mailerを呼び出すControllerを定義</h3>\n<p>MailerをどこかのControllerで呼び出してあげる必要があります。</p>\n<pre class=\"code\" data-unlink=\"\">\napp/controllers/hoge_controller.rb\n\ndef mail_send\n  @mail = TestMailer.sendmail.deliver\n  render :text => 'メール送信完了'\nend\n</pre>\n<p><a href=\"http://d.hatena.ne.jp/keyword/sendmail\">sendmail</a>メソッドはMail::Messageオブジェクトを返すだけなので、deliverメソッドを呼び出す必要があることに注意です。</p>\n"}}